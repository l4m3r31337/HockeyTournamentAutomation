{% load static %}
{% load tournament_filters %}
{% load tournament_tags %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–•–æ–∫–∫–µ–π–Ω—ã–µ —Ç—É—Ä–Ω–∏—Ä—ã</title>
    <link rel="stylesheet" href="{% static 'Hockey/css/fonts.css' %}">
    <link rel="stylesheet" href="{% static 'Hockey/css/style.css' %}">
</head>
<body>
    <header>
        <div class="navbar">
            <img src="{% static 'Hockey/logo.png' %}" alt="–õ–æ–≥–æ—Ç–∏–ø" class="logo">
            <nav>
                <ul class="nav-links">
                    <li><a href="../">–ì–ª–∞–≤–Ω–∞—è</a></li>
                    <li><a href="{% url 'tournament' %}">–¢—É—Ä–Ω–∏—Ä—ã</a></li>
                    <li><a href="{% url 'rating' %}">–†–µ–π—Ç–∏–Ω–≥–∏</a></li>
                    <li><a href="{% url 'index' %}#about">–û –Ω–∞—Å</a></li>
                    <li><a href="{% url 'index' %}#contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a></li>
                </ul>
            </nav>
            <a class="profile-icon" href="{% url 'profile' %}"><img src="{% static 'Hockey/user.svg' %}"></a>
        </div>
    </header>

    <main>
    <h1>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ç—É—Ä–Ω–∏—Ä—ã</h1>
    
    {% if players_count >= 12 %}
    <form method="post">
        {% csrf_token %}
        <button type="submit" name="create_tournament" class="btn btn-primary">
            –°–æ–∑–¥–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
        </button>
    </form>
    {% else %}
    <p>–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –º–∏–Ω–∏–º—É–º 12 –∏–≥—Ä–æ–∫–æ–≤ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ</p>
    {% endif %}
    
    {% for tournament in tournaments %}
    <div class="tournament-section">
        <h2>
            <form method="post" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="edit_tournament_id" value="{{ tournament.id }}">
                <input type="text" name="new_name" value="{{ tournament.name }}">
                <button type="submit" name="rename_tournament" class="btn btn-sm btn-secondary">üíæ</button>
            </form>

            <form method="post" style="display:inline;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä {{ tournament.name }}?');">
                {% csrf_token %}
                <input type="hidden" name="delete_tournament_id" value="{{ tournament.id }}">
                <button type="submit" class="btn btn-danger btn-sm">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </h2>
        
        {% for table in tournament.tournamenttable_set.all %}
        <form method="post" class="tournament-form">
            {% csrf_token %}
            <input type="hidden" name="tournament_id" value="{{ tournament.id }}">
            <input type="hidden" name="table_id" value="{{ table.id }}">
            
            <table class="tournament-table">
                <thead>
                    <tr>
                        <th>‚Ññ</th>
                        <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                        {% for i in range_1_10 %}
                        <th>–ò–≥—Ä–∞ {{ i }}</th>
                        {% endfor %}
                        <th>–†–∞–∑–Ω–æ—Å—Ç—å</th>
                    </tr>
                    <tr class="score-input-row">
                        <td></td>
                        <td></td>
                        {% for i in range_1_10 %}
                        <td>
                            <input type="number" class="red-score" min="0" step="1" name="game_{{ i }}_red" value="0">
                            <span> : </span>
                            <input type="number" class="blue-score" min="0" step="1" name="game_{{ i }}_blue" value="0">
                        </td>
                        {% endfor %}
                        <td></td>
                    </tr>
                </thead>
                <tbody>
                    {% for result in table.tournamentresult_set.all %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ result.player.username }}{% if result.player.userprofile.position == '–í—Ä–∞—Ç–∞—Ä—å' %} (–í){% endif %}</td>
                        {% for i in range_1_10 %}
                            {% with game_key="game"|add:i %}
                                {% get_player_team table forloop.parentloop.counter0 i as game_team %}
                                <td class="game-result {% if game_team == 'blue' %}team-blue{% elif game_team == 'red' %}team-red{% endif %}"
                                    data-game="{{ i }}" data-team="{{ game_team }}">
                                    {{ result.game_results|get_item:game_key|default:"0:0" }}
                                </td>
                            {% endwith %}
                        {% endfor %}
                        <td class="total-score">{{ result.total_score }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <button type="submit" name="save_results" class="btn btn-success">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            </button>
        </form>
        {% endfor %}
    </div>
    {% endfor %}
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.score-input-row input').forEach(input => {
            input.addEventListener('input', function() {
                const gameCell = this.closest('td');
                const gameNum = gameCell.cellIndex - 1; // –ù–æ–º–µ—Ä –∏–≥—Ä—ã (1-10)
                
                const redInput = gameCell.querySelector('.red-score');
                const blueInput = gameCell.querySelector('.blue-score');
                const redScore = parseInt(redInput.value) || 0;
                const blueScore = parseInt(blueInput.value) || 0;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —è—á–µ–π–∫–∏ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –¥–ª—è —ç—Ç–æ–π –∏–≥—Ä—ã
                document.querySelectorAll(`.game-result[data-game="${gameNum}"]`).forEach(cell => {
                    const team = cell.dataset.team;
                    cell.textContent = team === 'blue' ? `${blueScore}:${redScore}` : `${redScore}:${blueScore}`;
                    updateTotalScore(cell.closest('tr'));
                });
            });
        });
        
        function updateTotalScore(row) {
            let total = 0;
            row.querySelectorAll('.game-result').forEach(cell => {
                const [goalsFor, goalsAgainst] = cell.textContent.split(':').map(Number);
                const team = cell.dataset.team;
                // –î–ª—è —Å–∏–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã —Ä–∞–∑–Ω–æ—Å—Ç—å = –∑–∞–±–∏—Ç—ã–µ - –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ
                // –î–ª—è –∫—Ä–∞—Å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã —Ä–∞–∑–Ω–æ—Å—Ç—å = –∑–∞–±–∏—Ç—ã–µ - –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ (–Ω–æ –æ–Ω–∏ –∏–≥—Ä–∞—é—Ç –∑–∞ –∫—Ä–∞—Å–Ω—ã—Ö)
                if (team === 'blue') {
                    total += (goalsFor - goalsAgainst);
                } else if (team === 'red') {
                    total += (goalsFor - goalsAgainst);
                }
            });
            row.querySelector('.total-score').textContent = total;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞–∑–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.querySelectorAll('tbody tr').forEach(row => {
            updateTotalScore(row);
        });
    });
</script>
</body>
</html>